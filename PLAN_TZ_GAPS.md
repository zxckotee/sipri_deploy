# План доработок по ТЗ «СИПРИ версия 29.12.25» (слайды 1–39)

Документ описывает **что именно доделать** (по блокам ТЗ), **какие изменения в БД/коде/UX** потребуются, и **как резать на итерации**.

Сопутствующие материалы:
- Матрица текущего соответствия: `c:\sipri\public_html\crm\docs\sipri\spec-matrix-2026-01-26.md`
- ТЗ: `c:\sipri\ТЗ СИПРИ версия 29.12.25.pptx`

---

## Итерации (рекомендация)

### MVP (2–4 итерации)
- Вход/главная: поиск предприятия, понятная регистрация внешних участников.
- Идеи: “поделиться” по оргструктуре + соавторы + анти‑дубликат.
- Согласования: мульти‑адресаты “смежных руководителей” + правила архива по веткам.
- Исполнение: “исполнитель сообщает руководителю” и “руководитель завершает”.
- Мини‑интеграция: вкладки “Мессенджер/Почта” как ссылки.

### v1
- Полный “замок директора” + выборочные допуски.
- Антифлуд/бан по ролям и сроку.
- Бонусы/рейтинг автора.

### v2
- Интеграции с СЭД (вкладка/экспорт/ссылки → затем API).
- Пакет интеграции для сайтов предприятий (виджет/SSO).

---

## 1) Вход/главная (слайды 1–2, 39)

### 1.1 Поиск предприятия/компании на экране входа
**Цель:** реализовать UX “на главной/входе” выбор предприятия (tenant) и затем вход/регистрация.

**Изменения:**
- Добавить публичную страницу (например `sipri-portal`) с:
  - поиском по `sipri_tenants.name/slug`
  - кнопками “Войти” / “Регистрация”
- Вариант реализации:
  - новый контроллер: `app/Controllers/SipriPortal.php`
  - view: `app/Views/sipri/portal/index.php`
  - route: `sipri-portal` (вне `SipriBaseController`)

**Данные:**
- использовать `sipri_tenants` (уже есть) + `is_active`.

### 1.2 Отдельный флоу регистрации внешних участников (смежные/клиенты)
**Цель:** не “client user вошёл”, а понятная регистрация с ограничениями.

**MVP‑вариант:**
- Типы внешних участников:
  - `client` (клиенты/потребители)
  - `partner` (смежные предприятия)
- На регистрации обязательные поля:
  - tenant (предприятие, найденное на шаге поиска)
  - email/пароль (или email‑верификация — как в текущем `Signup`)
  - контактные данные (для client: телефон/email; для partner: компания/должность — минимум)
  - опция “анонимно” (ник вместо ФИО) — уже есть в профиле СИПРИ, но нужен UX на регистрации

**Ограничения доступа:**
- Для внешних пользователей запретить:
  - `sipri/approvals`, `sipri/admin`, управление справочниками
  - просмотр “enterprise/partner” карточек, если пользователь `client`
- Для `partner`:
  - видеть структуру отделов смежных предприятий (без персональных данных)

**Изменения в коде:**
- Доработать/расширить `Signup` под типы регистрации “client/partner”.
- Добавить настройку “разрешить partner‑регистрацию” (по аналогии с `sipri_allow_clients`).
- В `SipriBaseController::require_sipri_access()` расширить кейсы: `partner` (по настройке + tenant).

**Изменения в БД (скорее всего):**
- В `users` добавить поля для внешних:
  - `sipri_external_type` (`client|partner`) если текущего `user_type=client` недостаточно
  - `sipri_company_name` (для partner/client)
  - `sipri_phone` (см. пункт 7)

---

## 2) “Правила участия” + видео/шаблоны (слайды 3–4)

### 2.1 Страница “Правила участия”
**Цель:** 3 варианта правил: свой / смежные / клиенты.

**MVP:**
- Использовать KB (help_categories/help_articles) как хранилище текста и вложений:
  - тип: `sipri_rules`
  - 3 категории на tenant:
    - “Правила для участников своего предприятия”
    - “Правила для участников смежных предприятий”
    - “Правила для клиентов”
- Страница `sipri/rules`:
  - вкладки 3 типа
  - “шаблоны” как attachments к статье
  - “видео” как поле URL (YouTube/внутренний) или файл

**Изменения:**
- Новый контроллер: `app/Controllers/SipriRules.php`
- Новые роуты: `sipri/rules`, `sipri/rules/view/...`
- Расширение KB‑данных:
  - добавить в `help_articles` поле `video_url` (или хранить в description как ссылку — быстрый MVP)

---

## 3) Идеи: совместная работа (слайды 5–18, 39)

### 3.1 “Поделиться карточкой” адресно (в отдел/руководителю)
**Цель:** действие “Поделиться” создаёт адресата/маршрут, а не просто уведомление.

**MVP модель:**
- Новая таблица `sipri_idea_shares`:
  - `idea_id`
  - `from_user_id`
  - `to_type` (`department|user`)
  - `to_department_id` / `to_user_id`
  - `message` (опционально)
  - `created_at`
- UI:
  - кнопка “Поделиться” на карточке идеи
  - выбор: отдел (в пределах tenant) или конкретный руководитель/пользователь

### 3.2 Соавторы
**Цель:** добавлять соавторов в процессе обсуждения.

**Изменения:**
- Таблица `sipri_idea_coauthors`:
  - `idea_id`, `user_id`, `added_by`, `created_at`
- UI:
  - блок “Соавторы” на карточке (добавить/убрать)
- Права:
  - соавторы могут редактировать карточку (или только комментировать — решить политикой)

### 3.3 Антифлуд/бан на время
**Цель:** руководитель может “отключить” подачу/комменты/голосование пользователю на срок.

**Модель:**
- Таблица `sipri_user_restrictions`:
  - `tenant_id`
  - `user_id`
  - `restriction` (`create_idea|comment|vote|access`)
  - `reason`
  - `starts_at`, `ends_at`
  - `created_by`
- Enforcement:
  - в `SipriIdeas::save/vote/add_comment` проверять активные ограничения.

### 3.4 “Замок директора всем” + выборочные допуски (отдельно от is_secret)
**Цель:** директор может закрыть/открыть доступ к карточке (whitelist).

**Вариант:**
- Расширить `sipri_ideas`:
  - `is_locked` (bool)
  - `locked_by` (user_id)
  - `locked_at`
- Таблица `sipri_idea_access_locks` переопределить как whitelist:
  - добавить `granted_by`, `created_at`
- UI:
  - директор: “Поставить замок / Снять замок”
  - “Разрешить доступ пользователям …”

### 3.5 Бонусный счёт автора и рейтинг автора
**Цель:** копить “баллы” и показывать рейтинг автора по всем идеям.

**Модель (MVP):**
- `sipri_user_scores`:
  - `tenant_id`, `user_id`, `score_total`, `yes_total`, `no_total`, `updated_at`
- Пересчёт:
  - при каждом голосовании или cron‑джобой (быстрее/надёжнее — cron).

### 3.6 Полноценный анти‑дубликат
**MVP:**
- При создании/редактировании:
  - искать похожие идеи в tenant по:
    - совпадению/похожести title
    - полнотекст/LIKE по problem/idea
  - показывать список “похожие идеи” прямо в модалке.

---

## 4) Согласования “как в ТЗ” (слайд 39)

### 4.1 “Смежные руководители своего уровня” (мульти‑адресаты)
**Цель:** руководитель отдела отправляет идею “смежным” руководителям, затем вверх по вертикали до директора.

**Что нужно добавить:**
- Настройка “смежные отделы” (per department):
  - таблица `sipri_department_peers` (`department_id`, `peer_department_id`)
- При отправке на согласование:
  - автоматически создавать approvals:
    - peer managers (все) + далее директор
- UI:
  - у руководителя кнопка “Отправить смежным”
  - отображение списка “все согласования/отказы” (в карточке уже есть таблица — расширить)

### 4.2 Правило “чужие руководители не могут отправить в архив”
**Цель:** архивировать может только “своя вертикаль”.

**Реализация:**
- Явно вычислять “владельца ветки”:
  - отдел автора идеи → цепочка parent_id → директор tenant
- Архивировать/завершать могут только:
  - директор/делегат
  - руководитель отдела автора (и выше по parent chain)
- Enforcement:
  - в `SipriIdeas::archive` и в будущих действиях “reject” проверять ветку.

---

## 5) Исполнение (слайды 16–17)

Сейчас база есть, но нужно UX‑логика из ТЗ.

### 5.1 “Автор сообщает руководителю об исполнении”
**MVP:**
- Действие “Сообщить об исполнении” (executor):
  - статус `in_progress` → `awaiting_close`
  - поле `execution_report` заполняется исполнителем
- Уведомление руководителю/директору.

### 5.2 “Руководитель завершает карточку”
**MVP:**
- Действие “Завершить (успех/не успех)” доступно только руководителям ветки/директору.
- Итоговый перевод:
  - `awaiting_close` → `done_success|done_fail` → `archived`

**Изменения в БД:**
- Добавить статус `awaiting_close` (или переиспользовать существующий, но лучше явно).

---

## 6) Мессенджер/почта как вкладки/ссылки (слайды 24–27, 39)

**MVP:**
- В SIPRI добавить две кнопки/вкладки:
  - “Мессенджер”
  - “Почта”
- Настройки (tenant‑level):
  - `sipri_messenger_url`
  - `sipri_mail_url`

**Реализация:**
- В `sipri/settings` добавить поля (для `sipri_manage`).
- На `sipri` dashboard (`app/Views/sipri/index.php`) добавить кнопки, открывающие ссылки в новой вкладке.

---

## 7) Профиль/настройки/помощь (слайды 28–33)

### 7.1 Профиль: телефон, дата рождения, UX как на макете
**Изменения:**
- Миграция: добавить в `users`:
  - `sipri_phone`
  - `sipri_birthdate` (DATE)
- UI: расширить `sipri/profile` (валидации зависят от anonymous/client).

### 7.2 Настройки: звуки/оформление/шрифт/клавиатура
**MVP:**
- хранить в user settings (в `users` или `settings` как `user_{id}_*`)
  - `sipri_sound_enabled`
  - `sipri_theme`
  - `sipri_font_scale`
  - `sipri_keyboard_mode` (если нужно)
- UI: добавить секции на `sipri/settings`.

### 7.3 Техподдержка: “вопрос + история” в SIPRI‑UX
**MVP:**
- Если включён `module_ticket`:
  - показывать embedded list/shortcut “создать заявку/мои заявки”
  - фильтр по `client_id` или по staff user
- Если tickets отключены:
  - форма “вопрос” отправляет email на администратора (опционально).

---

## 8) Интеграции (слайд 39)

### 8.1 Интеграционный пакет для сайтов предприятий
**MVP deliverables:**
- Готовый HTML‑фрагмент кнопки/ссылки
- Рекомендации по размещению в Bitrix/интранете
- Список параметров/варианты URL (в т.ч. deep link на разделы)

**Реализация:**
- Док: добавить раздел в `c:\sipri\README.md`
- Опционально: endpoint “health” + статичная страница `/sipri-portal`.

### 8.2 Интеграция с СЭД (например “Практика”)
**MVP (без API):**
- Вкладка/раздел “СЭД” в SIPRI:
  - ссылки на внешние системы
  - экспорт PDF/Docx отчёта по карточке идеи

**v2 (API):**
- Вынести сервисный слой:
  - webhooks “idea approved/done”
  - импорт/синхронизация статусов

---

## Технические заметки
- Источники данных для оргструктуры уже есть:
  - `sipri_tenants.director_user_id`
  - `sipri_departments.manager_user_id/deputy_user_id/parent_id`
  - `sipri_delegations`
- Для корректной “ветки” потребуется функция вычисления chain по `parent_id`.
- Для внешних пользователей нужен явный тип (`client|partner`) и жёсткие проверки видимости по tenant/category.


